<script>_500px.init({sdk_key: '29f8908d90c874398a67d534c33d79f6cb652ec5'});</script>

<%= form_for(@dream) do |f| %>
	<% if @dream.errors.any? %>
		<%= render 'shared/error_messages', object: @dream %>
	<% end %>
  <ul id="myTab" class="nav nav-tabs">
    <li><a href="#tab_dream" data-toggle="pill">Enter Dream</a></li>
    <li><a href="#tab_image" data-toggle="pill">Dream Image</a></li>
    <li><a href="#tab_details" data-toggle="pill">More Details</a></li>
  </ul>
  <div class="tab-content" id="myTabContent">
  	<div id="tab_dream" class="tab-pane fade in active">
  		<%= f.text_field :title, :placeholder => "Dream title" %> <br />
			<%= f.text_area :content, :placeholder => "Narrate your dream..." %> <br />
			<%= f.radio_button :privacy, "true" %>
			<%= f.label(:private_true, "Private") %>
			<%= f.radio_button :privacy, "false" %>
			<%= f.label(:private_false, "Public") %>
		</div>
		<div id="tab_image" class="tab-pane fade in">
  		<div class="clearfix">
	  		
	  		<label>Search your image: </label>
				<input id="search-input" type="text"/>
				<a class="btn btn-primary btn-small search-button">Search</a>
				<ol id="selectable"></ol>

			</div>
			<div><a class="loadMore"></a></div>
			<div><a class="loadLess"></a></div>
			<input type="hidden" id="counter">
			<%= f.hidden_field :imagesource %>
		</div>
  	<div id="tab_details" class="tab-pane fade in">
  		<div class="field">
				<%= f.check_box :nightmare %>
				<%= label(:nightmare, "Nightmare") %>
				<%= f.check_box :lucid %>
				<%= label(:lucid, "Lucid") %>
				<%= f.check_box :recurring %>
				<%= label(:recurring, "Recurring") %>
				<%= f.check_box :fragmented %>
				<%= label(:fragmented, "Fragmented") %>
			</div>
			<div class="field">
				<% if @dream.emotion %>
					<% @menu_blank = @dream.emotion %>
				<% else %>
					<% @menu_blank = "Select Emotion" %>
				<% end %>
				<%= f.select :emotion, ([["Inspired", "Inspired"], ["Relieved", "Relieved"], ["Afraid", 
					"Afraid"], ["Sad", "Sad"], ["Surprised", "Surprised"]]), :include_blank => @menu_blank %>
			</div>
			<div class="field">
				<%= f.text_area :hashtag, :placeholder => "#characters, #activities, #objects" %>
			</div>
		</div>
	</div>
	<br /><br />
	<%= f.submit "Save", class: "btn btn-primary btn-large" %> <br /><br />
<% end %>

<script type="text/javascript">
	$(function() {	
		$(".search-button").click(function() {
			$(".loadLess").html('');
			$(".loadMore").html('');
			$('#selectable').html('Loading...');
			var search_term = $("#search-input").val();
			_500px.api('/photos/search', {term: search_term, sort: "rating", image_size: 2}, function (response) {
			  if (response.success) {  
			    $("#selectable").html('');
			    $.each(response.data.photos, function(i,photo){
			      $("#selectable").append("<li><img src = "+photo.image_url+" /></li>");
			      if (i == 20) return false;
			    });
			    var imgsrc=""; // Selecting the image source
				  $("#selectable li").click(function() {
		  			$(this).addClass("selected").siblings().removeClass("selected");
		  			var imgsrc = $('li.selected img').attr('src');
				    var imgsave = imgsrc.replace('2.jpg', '4.jpg');
				    $("#dream_imagesource").val(imgsave);
		  		});
		  		if(response.data.total_pages > 1) {
		  			$(".loadMore").append("<a>Load More -> </a>");
		  		}		  		
			  } else {
			  	alert('Sorry request lost (1): ' + response.status + ' - ' + response.error_message);
			  }
			});
		});
	});
</script>
<script type="text/javascript">
	$(function() {	
		var counter = 1;
		$(".loadMore").click(function() {
			var search_term = $("#search-input").val();
			$('#selectable').html('');
			$(".loadLess").html('');
			$(".loadMore").html('');
			$('#selectable').html('Loading more...');
			counter += 1;
			$("#counter").text(counter);
			_500px.api('/photos/search', {term: search_term, sort: "rating", image_size: 2, page: counter}, function (response) {
			  if (response.success) {  
			    $("#selectable").html('');
			    $.each(response.data.photos, function(i,photo){
			      $("#selectable").append("<li><img src = "+photo.image_url+" /></li>");
			      if (i == 20) return false;
			    });		  
				  var imgsrc = ""; // Selecting the image source
				  $("#selectable li").click(function() {
		  			$(this).addClass("selected").siblings().removeClass("selected");
		  			var imgsrc = $('li.selected img').attr('src');
				    var imgsave = imgsrc.replace('2.jpg', '4.jpg');
				    $("#dream_imagesource").val(imgsave);
		  		});
		  		$(".loadMore").append("<a>Load More -> </a>");
		  		$(".loadLess").append("<a> <- Previous</a>");
		  		if(response.data.current_page == response.data.total_pages) {
						$(".loadMore").html('');
					}
			  } else {
			  	alert('Sorry request lost (2): ' + response.status + ' - ' + response.error_message);
			  }
			}); 
		});
		$(".loadLess").click(function() {
			var search_term = $("#search-input").val();
			$('#selectable').html('');
			$(".loadLess").html('');
			$(".loadMore").html('');
			$('#selectable').html('Loading more...');	
			counter -= 1;
			$("#counter").text(counter);
			_500px.api('/photos/search', {term: search_term, sort: "rating", image_size: 2, page: counter}, function (response) {
			  if (response.success) {  
			    $("#selectable").html('');
			    $.each(response.data.photos, function(i,photo){
			      $("#selectable").append("<li><img src = "+photo.image_url+" /></li>");
			      if (i == 20) return false;
			    });		  
				  var imgsrc = ""; // Selecting the image source
				  $("#selectable li").click(function() {
		  			$(this).addClass("selected").siblings().removeClass("selected");
		  			var imgsrc = $('li.selected img').attr('src');
				    var imgsave = imgsrc.replace('2.jpg', '4.jpg');
				    $("#dream_imagesource").val(imgsave);
		  		});
		  		$(".loadMore").append("<a>Load More -> </a>");
		  		$(".loadLess").append("<a> <- Previous</a>");  		
					if(response.data.current_page == 1) {
						$(".loadLess").html('');
					}
			  } else {
			  	alert('Sorry request lost (3): ' + response.status + ' - ' + response.error_message);
			  }
			}); 
		});
	});
</script>
<script type="text/javascript">
	$('#myTab a:first').tab('show'); 
</script>
