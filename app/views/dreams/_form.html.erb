<script>_500px.init({sdk_key: '29f8908d90c874398a67d534c33d79f6cb652ec5'});</script>
<%= form_for(@dream) do |f| %>
	<div data-role="page" id="record">
		<div data-role="header">
			<%= link_to 'Cancel', home_path, rel: "external" %>
			<h4>Record Dream</h4>
			<a class="ui-btn-right submit">Save</a>
		</div>
		<% if @dream.errors.any? %>
			<%= render 'shared/error_messages', object: @dream %>
		<% end %>
		<div class="dreamrecord">
			<%= f.text_field :title,   placeholder: "Dream title", style: "border-bottom: 1px dotted #FBA617; padding-bottom: 0px; border-radius: 0;" %>
			<%= f.text_area  :content, placeholder: "Narrate your dream...", style: "padding-top: 0px;" %>
		</div>
		<% if @dream.imagesource %>
			<div id="thumb_show" class="thumbbox">
				<img src = "<%= @dream.imagesource.gsub('3.jpg', '1.jpg') %>" />
			</div>
		<% else %>
			<div id="thumb_show"></div>
		<% end %>
		<div class="searchbox">
			<a href="#search" data-transition="slide">Search for an image</a>
		</div>
		<div class="slider">
			<small class="privtext">This dream is Private, for your eyes only.</small>
			<small class="privtext" style="display: none">Public dreams may be featured on LiveWire!</small>
			<div id="privacy-toggle">
				<select name="dream[privacy]" id="dream_privacy" data-role="slider">
				  <option value="true">Private</option>
				  <option value="false">Public</option>
				</select>
			</div>
		</div>
		<div class="footerpadding">
			<a href="#details" data-transition="slideup">More...</a>
		</div>
	</div>
	<div data-role="page" id="search">
		<div data-role="header">
			<a href="#" data-rel="back">Back</a>
			<h4>Select Image</h4>
		</div>	
		<div class="clearfix">
			<p class="searchtext">
				Search for an image that best symbolizes (viusally and emotionally) your dream:
			</p>
			<div class="margin-bottom">
			<input id="search-input" type="text" placeholder="Search eg. red sky" style="border-bottom: 1px dotted #FBA617; width: 200px; border-radius: 0;" />
			<a class="search-button" data-role="button" data-inline="true">Search</a>
			</div>
			<ol id="selectable"></ol>
		</div>
		<div><a class="loadMore"></a></div>
		<div><a class="loadLess"></a></div>
		<input type="hidden" id="counter">
		<%= f.hidden_field :imagesource %>
	</div>
	<div data-role="page" id="details">
		<div data-role="header">
			<h4>Record Dream</h4>
			<a class="ui-btn-right submit">Save</a>
		</div>	
		<div data-role="fieldcontain" class="margin-top">
			<fieldset data-role="controlgroup" data-type="horizontal" data-mini="true">
				<label><%= f.check_box :nightmare %> Nightmare </label>				
				<label><%= f.check_box :lucid %> Lucid </label>				
				<label><%= f.check_box :recurring %> Recurring </label>				
				<label><%= f.check_box :fragmented %> Fragment </label>				
			</fieldset>
		</div>
		<div class="field margin-top">
			<% if @dream.emotion && @dream.emotion != "" %>
				<% @menu_blank = @dream.emotion %>
			<% else %>
				<% @menu_blank = "Select Emotion" %>
			<% end %>
			<%= f.select :emotion, ([["Inspired", "Inspired"], ["Relieved", "Relieved"], ["Afraid", 
				"Afraid"], ["Sad", "Sad"], ["Surprised", "Surprised"]]), :include_blank => @menu_blank %>
		</div>
		<div class="field margin-top">
			<%= f.text_area :hashtag, :placeholder => "#characters, #activities, #objects", style: "border: 1px solid #aaa; border-radius: 0.6em; padding-left: 4px;" %>
		</div>
		<div class="footerpadding">
			<a href="#record" data-transition="slidedown">Less...</a>
		</div>
	</div>
<% end %>
<script type="text/javascript">
	$(function() {	
		$(".search-button").click(function() {
			$(".loadLess").html('');
			$(".loadMore").html('');
			$('#selectable').html('Loading...');
			var search_term = $("#search-input").val();
			_500px.api('/photos/search', {term: search_term, sort: "rating", image_size: 2}, function (response) {
			  if (response.success) {  
			    $("#selectable").html('');
			    $.each(response.data.photos, function(i,photo){
			      $("#selectable").append("<li><img src ="+photo.image_url+" /> <p style='display:none'>"+photo.user.fullname+"</p></li>");
			      if (i == 20) return false;
			    });
			    var imgsrc=""; // Selecting the image source
				  $("#selectable li").click(function() {
		  			$(this).addClass("selected").siblings().removeClass("selected");
		  			var imgsrc = $('li.selected img').attr('src');
				    var imgsave = imgsrc.replace('2.jpg', '3.jpg');
				    var imgthumb = imgsrc.replace('2.jpg', '1.jpg');
				    $("#dream_imagesource").val(imgsave);
				    $.mobile.changePage( "#record", {transition: "slide", reverse: true});
				    $("#thumb_show").html('').append("<img src = "+imgthumb+" />");
		  		});
		  		if(response.data.total_pages > 1) {
		  			$(".loadMore").append("<a>Load More > </a>");
		  		}		  		
			  } else {
			  	alert('Sorry request lost (1): ' + response.status + ' - ' + response.error_message);
			  }
			});
		});
	});
</script>
<script type="text/javascript">
	$(function() {	
		var counter = 1;
		$(".loadMore").click(function() {
			var search_term = $("#search-input").val();
			$('#selectable').html('');
			$(".loadLess").html('');
			$(".loadMore").html('');
			$('#selectable').html('Loading...');
			counter += 1;
			$("#counter").text(counter);
			_500px.api('/photos/search', {term: search_term, sort: "rating", image_size: 2, page: counter}, function (response) {
			  if (response.success) {  
			    $("#selectable").html('');
			    $.each(response.data.photos, function(i,photo){
			      $("#selectable").append("<li><img src ="+photo.image_url+" /> <p style='display:none'>"+photo.user.fullname+"</p></li>");
			      if (i == 20) return false;
			    });		  
				  var imgsrc = ""; // Selecting the image source
				  $("#selectable li").click(function() {
		  			$(this).addClass("selected").siblings().removeClass("selected");
		  			var imgsrc = $('li.selected img').attr('src');
				    var imgsave = imgsrc.replace('2.jpg', '3.jpg');
				    var imgthumb = imgsrc.replace('2.jpg', '1.jpg');
				    $("#dream_imagesource").val(imgsave);
				    $.mobile.changePage( "#record", {transition: "slide", reverse: true});
				    $("#thumb_show").html('').append("<img src = "+imgthumb+" />");
		  		});
		  		$(".loadMore").append("<a>Load More > </a>");
		  		$(".loadLess").append("<a> < Previous</a>");
		  		if(response.data.current_page == response.data.total_pages) {
						$(".loadMore").html('');
					}
			  } else {
			  	alert('Sorry request lost (2): ' + response.status + ' - ' + response.error_message);
			  }
			}); 
		});
		$(".loadLess").click(function() {
			var search_term = $("#search-input").val();
			$('#selectable').html('');
			$(".loadLess").html('');
			$(".loadMore").html('');
			$('#selectable').html('Loading...');	
			counter -= 1;
			$("#counter").text(counter);
			_500px.api('/photos/search', {term: search_term, sort: "rating", image_size: 2, page: counter}, function (response) {
			  if (response.success) {  
			    $("#selectable").html('');
			    $.each(response.data.photos, function(i,photo){
			      $("#selectable").append("<li><img src ="+photo.image_url+" /> <p style='display:none'>"+photo.user.fullname+"</p></li>");
			      if (i == 20) return false;
			    });		  
				  var imgsrc = ""; // Selecting the image source
				  $("#selectable li").click(function() {
		  			$(this).addClass("selected").siblings().removeClass("selected");
		  			var imgsrc = $('li.selected img').attr('src');
				    var imgsave = imgsrc.replace('2.jpg', '3.jpg');
				    var imgthumb = imgsrc.replace('2.jpg', '1.jpg');
				    $("#dream_imagesource").val(imgsave);
				    $.mobile.changePage( "#record", {transition: "slide", reverse: true});
				    $("#thumb_show").html('').append("<img src = "+imgthumb+" />");
		  		});
		  		$(".loadMore").append("<a>Load More > </a>");
		  		$(".loadLess").append("<a> < Previous</a>");  		
					if(response.data.current_page == 1) {
						$(".loadLess").html('');
					}
			  } else {
			  	alert('Sorry request lost (3): ' + response.status + ' - ' + response.error_message);
			  }
			}); 
		});
	});
</script>
<script type="text/javascript">
	$('.submit').click(function(){
    $('form').submit();
    return false;
	});
</script>
<% if @dream.privacy == false %> 
	<script type="text/javascript"> // for edit, updates if the dream was public
		$(".privtext").toggle();
		$('#dream_privacy').val('false').slider('refresh');
	</script>
<% end %>
<script type="text/javascript"> // changes text next to privacy slider
	$("#privacy-toggle").on('slidestop', function() { 
		$(".privtext").toggle();
	});
</script>